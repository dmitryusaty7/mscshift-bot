# MSCShift Bot

Телеграм-бот для управления сменами и отчётами. Проект собирается по блокам. Реализованы точка входа (Блок 0) и регистрация бригадира (Блок 1).

## Технологический стек
- Node.js (LTS)
- PostgreSQL
- Directus (только просмотр данных и файлов)
- node-telegram-bot-api

## Архитектурные принципы
- Модульность: один файл — одна ответственность
- Все тексты вынесены в единый модуль `src/messages`
- Подключение к БД и репозитории разделены
- Простые логгеры и middleware для будущего расширения

## Структура проекта
```
src/
  bot/
    index.js              // запуск и регистрация обработчиков
    handlers/
      start.handler.js    // логика /start (Блоки 0-1)
    middlewares/
      session.js          // временное хранение состояния пользователя
    keyboards/
      common.keyboards.js // общие клавиатуры (заглушки)
  db/
    index.js              // создание пула PostgreSQL
    brigadiers.repo.js    // запросы к таблице brigadiers
  directus/               // клиент Directus для работы с файлами и сущностями
  messages/
    index.js              // все тексты бота
  modules/
    register.js           // FSM регистрации нового пользователя
  config/
    env.js                // проверка окружения
  utils/
    logger.js             // простой логгер
  index.js               // точка входа
```

## Блоки
- **Блок 0** — реализован: команда `/start`, поиск бригадира в БД, маршрутизация к регистрации или основной панели (заглушка)
- **Блок 1** — реализован: регистрация бригадира по ФИО с проверкой кириллицы и записью в `brigadiers`
- **Блок 2** — TODO: основная панель бригадира
- **Загрузка фото** — реализовано: получение фото от пользователя, отправка в Directus `/files`,
  создание записи в `shift_photos` с привязкой к смене и пользователю

## Блок 1 — регистрация бригадира
1. Пользователь отправляет `/start`.
2. Если его `telegram_id` не найден в таблице `brigadiers`, бот переводит пользователя в состояние регистрации.
3. Бот отправляет приветствие и просит ввести фамилию и имя кириллицей в одном сообщении (пример: `Иванов Иван`).
4. Валидация допускает только кириллицу и требует минимум два слова (имя и фамилия). При ошибке бот просит повторить ввод.
5. После успешной проверки бот сохраняет запись в `brigadiers` (имя, фамилия, `telegram_id`, `created_at`) и переводит пользователя в состояние авторизации.
6. Пользователь получает подтверждение и переводится к заглушке основной панели (Блок 2).

### Как проверить работу блока
- Перезапустить сервис, чтобы бот получил новый код: `systemctl restart mscshift-bot`
- Пройти регистрацию в Telegram, выполнив шаги выше
- Убедиться, что новая запись появилась в таблице `brigadiers`
- Проверить обновлённые файлы в GitHub

## Запуск
1. Скопировать пример окружения и заполнить переменные:
   - `TELEGRAM_BOT_TOKEN`
   - `PG_HOST`, `PG_PORT`, `PG_DATABASE`, `PG_USER`, `PG_PASSWORD`
   - `DIRECTUS_URL`, `DIRECTUS_STATIC_TOKEN`
   - (опционально) `DIRECTUS_USERS_COLLECTION`, `DIRECTUS_SHIFTS_COLLECTION`, `DIRECTUS_SHIFT_PHOTOS_COLLECTION`, `DIRECTUS_SHIFT_DEFAULT_STATUS`
2. Установить зависимости:
   ```bash
   npm install
   ```
3. Запустить бота:
   ```bash
   npm start
   ```

При старте бот проверяет подключение к PostgreSQL. Все сообщения пользователю отправляются на русском языке.
