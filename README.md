# MSCShift Bot

Телеграм-бот для управления сменами и отчётами. Проект собирается по блокам. Текущая реализация покрывает точку входа (Блок 0) и регистрацию (Блок 1).

## Технологический стек
- Node.js (LTS)
- PostgreSQL
- Directus (только просмотр данных и файлов)
- Telegraf

## Архитектурные принципы
- Модульность: один файл — одна ответственность
- Все тексты вынесены в единый модуль `src/messages`
- Подключение к БД и репозитории разделены
- Простые логгеры и middleware для будущего расширения

## Структура проекта
```
src/
  bot/
    index.js              // запуск и регистрация обработчиков
    handlers/
      start.handler.js    // логика /start (Блок 0)
    middlewares/
      session.js          // временное хранение состояния пользователя
    keyboards/
      common.keyboards.js // общие клавиатуры (заглушки)
    main-menu.js          // заглушка главного меню (Блок 2)
  scenes/
    register.scene.js     // сцена регистрации (Блок 1)
  db/
    index.js              // создание пула PostgreSQL
    brigadiers.repo.js    // запросы к таблице brigadiers
  messages/
    index.js              // все тексты бота
  config/
    env.js                // проверка окружения
  utils/
    logger.js             // простой логгер
  index.js               // точка входа
```

## Блоки
- **Блок 0** — реализован: команда `/start`, поиск бригадира в БД, маршрутизация к регистрации или основной панели (заглушки)
- **Блок 1** — реализован: сцена регистрации с запросом имени и фамилии, записью в таблицу `brigadiers`
- **Блок 2** — TODO: основная панель бригадира

### Регистрация (Блок 1)
1. При `/start` бот проверяет наличие пользователя по `telegram_id` в таблице `brigadiers`.
2. Если пользователь не найден, запускается сцена регистрации (Telegraf Wizard Scene):
   - Запрос имени (проверка: первая буква заглавная, далее строчные, 2–50 символов).
   - Запрос фамилии (те же правила).
   - Вставка записи в `brigadiers` с именем, фамилией и `telegram_id`.
3. По завершении регистрация завершается приветствием и переходом к заглушке главного меню (Блок 2).

## Запуск
1. Скопировать пример окружения и заполнить переменные:
   - `TELEGRAM_BOT_TOKEN`
   - `PG_HOST`, `PG_PORT`, `PG_DATABASE`, `PG_USER`, `PG_PASSWORD`
2. Установить зависимости:
   ```bash
   npm install
   ```
3. Запустить бота:
   ```bash
   npm start
   ```

При старте бот проверяет подключение к PostgreSQL. Все сообщения пользователю отправляются на русском языке.
